<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>parmed.tools.simulations.openmm &#8212; ParmEd 2.5.0 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '2.5.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="top" title="ParmEd 2.5.0 documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">ParmEd 2.5.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for parmed.tools.simulations.openmm</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains functionality for running simulations with OpenMM using</span>
<span class="sd">parameters defined in an input file for sander and pmemd.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">from</span> <span class="nn">parmed.amber</span> <span class="k">import</span> <span class="n">AmberMdcrd</span><span class="p">,</span> <span class="n">AmberMask</span><span class="p">,</span> <span class="n">NetCDFTraj</span><span class="p">,</span> <span class="n">Rst7</span>
<span class="kn">from</span> <span class="nn">parmed.amber.mdin</span> <span class="k">import</span> <span class="n">Mdin</span>
<span class="kn">from</span> <span class="nn">parmed.openmm</span> <span class="k">import</span> <span class="p">(</span><span class="n">StateDataReporter</span><span class="p">,</span> <span class="n">NetCDFReporter</span><span class="p">,</span> <span class="n">MdcrdReporter</span><span class="p">,</span>
        <span class="n">RestartReporter</span><span class="p">,</span> <span class="n">ProgressReporter</span><span class="p">,</span> <span class="n">EnergyMinimizerReporter</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">parmed.utils.timer</span> <span class="k">import</span> <span class="n">Timer</span>
<span class="kn">from</span> <span class="nn">parmed</span> <span class="k">import</span> <span class="n">unit</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">parmed.utils.six.moves</span> <span class="k">import</span> <span class="nb">range</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">sqrt</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">parmed.tools.exceptions</span> <span class="k">import</span> <span class="p">(</span><span class="n">SimulationError</span><span class="p">,</span> <span class="n">SimulationWarning</span><span class="p">,</span>
        <span class="n">UnhandledArgumentWarning</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">simtk.openmm.vec3</span> <span class="k">import</span> <span class="n">Vec3</span>
    <span class="kn">from</span> <span class="nn">simtk.openmm.app</span> <span class="k">import</span> <span class="p">(</span><span class="n">forcefield</span> <span class="k">as</span> <span class="n">ff</span><span class="p">,</span> <span class="n">OBC1</span><span class="p">,</span> <span class="n">OBC2</span><span class="p">,</span> <span class="n">GBn</span><span class="p">,</span> <span class="n">HCT</span><span class="p">,</span> <span class="n">GBn2</span><span class="p">,</span>
                                  <span class="n">Simulation</span><span class="p">,</span> <span class="n">DCDReporter</span><span class="p">,</span> <span class="n">amberprmtopfile</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">simtk.openmm</span> <span class="k">as</span> <span class="nn">mm</span>
    <span class="n">HAS_OPENMM</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">HAS_OPENMM</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">_SCRIPT_HEADER</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">#!/usr/bin/env python</span>
<span class="s2">from __future__ import division, print_function</span>

<span class="s2">import os, sys</span>

<span class="s2"># Import the OpenMM modules that are necessary</span>
<span class="s2">from simtk.openmm.app import *</span>
<span class="s2">from simtk.openmm import *</span>

<span class="s2"># Import the Amber/OpenMM modules</span>
<span class="s2">from parmed.amber import AmberParm, Rst7, AmberMdcrd, AmberMask, NetCDFTraj</span>
<span class="s2">from parmed.openmm import (StateDataReporter, NetCDFReporter, MdcrdReporter,</span>
<span class="s2">        RestartReporter, ProgressReporter, EnergyMinimizerReporter)</span>
<span class="s2">from parmed import unit as u</span>
<span class="s2">from parmed.utils.six.moves import range</span>

<span class="s2"># Load the Amber topology file</span>
<span class="s2">parm = AmberParm(&#39;</span><span class="si">%s</span><span class="s2">&#39;, &#39;</span><span class="si">%s</span><span class="s2">&#39;)</span>
<span class="s2">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="positional_restraints"><a class="viewcode-back" href="../../../../api/parmed/parmed.tools.simulations.openmm.html#parmed.tools.simulations.openmm.positional_restraints">[docs]</a><span class="k">def</span> <span class="nf">positional_restraints</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">refc</span><span class="p">,</span> <span class="n">scriptfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a positional restraint force from CustomExternalForce using the</span>
<span class="sd">    coordinates given in the refc restart file for the atoms specified in &#39;mask&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parm</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">parm</span> <span class="c1"># store the parm object</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">refc</span><span class="o">.</span><span class="n">valid</span> <span class="ow">or</span> <span class="n">refc</span><span class="o">.</span><span class="n">natom</span> <span class="o">!=</span> <span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;natom&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;Invalid (or incompatible) reference coordinate &#39;</span>
                              <span class="s1">&#39;file&#39;</span><span class="p">)</span>

    <span class="c1"># Make the (very simple) force term</span>
    <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">wt</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilocalories_per_mole</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Create the positional restraint force</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;frc = CustomExternalForce(&#39;k*((x-x0)*(x-x0)+&quot;</span>
                         <span class="s2">&quot;(y-y0)*(y-y0)+(z-z0)*(z-z0))&#39;)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;frc.addGlobalParameter(&#39;k&#39;, </span><span class="si">%s</span><span class="s2">*u.kilocalorie_per_mole&quot;</span>
                         <span class="s2">&quot;/u.angstroms**2)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">wt</span><span class="p">)</span>
        <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;frc.addPerParticleParameter(&#39;x0&#39;)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;frc.addPerParticleParameter(&#39;y0&#39;)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;frc.addPerParticleParameter(&#39;z0&#39;)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;for idx in mask.Selected():</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;    frc.addParticle(idx, refc.positions[idx])</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">frc</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">CustomExternalForce</span><span class="p">(</span><span class="s1">&#39;k*((x-x0)*(x-x0)+(y-y0)*(y-y0)+&#39;</span>
                                    <span class="s1">&#39;(z-z0)*(z-z0))&#39;</span><span class="p">)</span>
    <span class="n">frc</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
    <span class="n">frc</span><span class="o">.</span><span class="n">addPerParticleParameter</span><span class="p">(</span><span class="s1">&#39;x0&#39;</span><span class="p">)</span>
    <span class="n">frc</span><span class="o">.</span><span class="n">addPerParticleParameter</span><span class="p">(</span><span class="s1">&#39;y0&#39;</span><span class="p">)</span>
    <span class="n">frc</span><span class="o">.</span><span class="n">addPerParticleParameter</span><span class="p">(</span><span class="s1">&#39;z0&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">mask</span><span class="o">.</span><span class="n">Selected</span><span class="p">():</span>
        <span class="n">frc</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">refc</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">frc</span></div>

<div class="viewcode-block" id="simulate"><a class="viewcode-back" href="../../../../api/parmed/parmed.tools.simulations.openmm.html#parmed.tools.simulations.openmm.simulate">[docs]</a><span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="n">parm</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Runs a simulation using OpenMM &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">HAS_OPENMM</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">HAS_OPENMM</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;Could not import OpenMM!&#39;</span><span class="p">)</span>

    <span class="c1"># Set up timers</span>
    <span class="n">timer</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">add_timer</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="s1">&#39;OpenMM System creation&#39;</span><span class="p">)</span>
    <span class="c1"># Handle Amber command-line arguments</span>
    <span class="n">overwrite</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;-O&#39;</span><span class="p">)</span>
    <span class="n">inputfile</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="s1">&#39;mdin&#39;</span><span class="p">)</span>
    <span class="n">inpcrd</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">outputfile</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="s1">&#39;mdout&#39;</span><span class="p">)</span>
    <span class="n">trajectory</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;-x&#39;</span><span class="p">,</span> <span class="s1">&#39;mdcrd&#39;</span><span class="p">)</span>
    <span class="n">mdvel</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;mdvel&#39;</span><span class="p">)</span>
    <span class="n">mdfrc</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;-frc&#39;</span><span class="p">,</span> <span class="s1">&#39;mdfrc&#39;</span><span class="p">)</span>
    <span class="n">restart</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;-r&#39;</span><span class="p">,</span> <span class="s1">&#39;restrt&#39;</span><span class="p">)</span>
    <span class="n">refc</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;-ref&#39;</span><span class="p">,</span> <span class="s1">&#39;refc&#39;</span><span class="p">)</span>
    <span class="n">mdinfo</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;-inf&#39;</span><span class="p">,</span> <span class="s1">&#39;mdinfo&#39;</span><span class="p">)</span>
    <span class="n">inptrajname</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;-y&#39;</span><span class="p">,</span> <span class="s1">&#39;inptraj&#39;</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;-cpin&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;-cprestrt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;-cpout&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;-remlog&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">rem</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get_key_int</span><span class="p">(</span><span class="s1">&#39;-rem&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Some OpenMM-specific options</span>
    <span class="n">plat</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;-platform&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">prec</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;-precision&#39;</span><span class="p">,</span> <span class="s1">&#39;mixed&#39;</span><span class="p">)</span>
    <span class="n">dcd</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;dcd&#39;</span><span class="p">)</span>
    <span class="n">scriptfile</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">runsim</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;norun&#39;</span><span class="p">)</span>
    <span class="n">printprogress</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;progress&#39;</span><span class="p">)</span>
    <span class="c1"># Get any unmarked arguments</span>
    <span class="n">unmarked_cmds</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">unmarked</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unmarked_cmds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Un-handled arguments: &quot;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unmarked_cmds</span><span class="p">),</span>
                      <span class="n">UnhandledArgumentWarning</span><span class="p">)</span>

    <span class="c1"># Open up the script file and write the header if requested</span>
    <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scriptfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">scriptfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inpcrd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_SCRIPT_HEADER</span> <span class="o">%</span> <span class="p">(</span><span class="n">parm</span><span class="p">,</span> <span class="n">inpcrd</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_SCRIPT_HEADER</span> <span class="o">%</span> <span class="p">(</span><span class="n">parm</span><span class="p">,</span> <span class="n">parm</span><span class="o">.</span><span class="n">crdname</span><span class="p">))</span>

    <span class="c1"># Parse the input file</span>
    <span class="n">mdin</span> <span class="o">=</span> <span class="n">Mdin</span><span class="p">()</span>
    <span class="n">mdin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">inputfile</span><span class="p">)</span>

    <span class="c1"># We run MD if imin == 0</span>
    <span class="n">runmd</span> <span class="o">=</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;imin&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="c1"># Process out all of the illegal options that are not supported here</span>
    <span class="k">if</span> <span class="n">rem</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;Replica exchange simulations are not supported.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;icnstph&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;Constant pH simulations are not supported.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ifqnt&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;QM/MM simulations are not supported.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ievb&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;Empirical Valence Bond simulations &#39;</span>
                              <span class="s1">&#39;not supported.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ipb&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;PB simulations not supported&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;irism&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;3D-RISM simulations are not supported.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ifcr&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;Charge relocation is not supported.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;icfe&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;Thermodynamic integration is not supported.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;idecomp&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;Residue decomposition is not supported.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;isgld&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;Self-guided langevin dynamics is not supported.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;itgtmd&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;Targeted MD is not supported.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ineb&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;Nudged elastic band is not supported.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;iamd&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;Accelerated MD is not supported.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ipimd&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;Path-integral MD is not supported.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ilscivr&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;Linearized semi-classical simulations are not &#39;</span>
                              <span class="s1">&#39;supported.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;ifbox&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;igb&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;Cannot treat periodic system with GB&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;nmropt&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;NMR restraints are not supported.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">runmd</span> <span class="ow">and</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;gamma_ln&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;Langevin integrator needs a non-zero friction &#39;</span>
                              <span class="s1">&#39;coefficient&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ioutfm&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;ioutfm must be 0 or 1&#39;</span><span class="p">)</span>
    <span class="c1"># Catch some illegal trajectory printing options</span>
    <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ioutfm&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">dcd</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Forcefully setting ioutfm=1 to print DCD-formatted &#39;</span>
                      <span class="s1">&#39;trajectories.&#39;</span><span class="p">,</span> <span class="n">SimulationWarning</span><span class="p">)</span>
        <span class="n">mdin</span><span class="o">.</span><span class="n">change</span><span class="p">(</span><span class="s1">&#39;cntrl&#39;</span><span class="p">,</span> <span class="s1">&#39;ioutfm&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwv&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwf&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ioutfm&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">dcd</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;Only NetCDF trajectories can have velocities&#39;</span>
                                  <span class="s1">&#39; and/or forces printed to the same file.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwv&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwf&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dcd</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;cannot print velocities or forces to DCD files.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwr&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;ntwr is set quite low (</span><span class="si">%d</span><span class="s1">). Consider much larger values &#39;</span>
                      <span class="s1">&#39;to improve computational performance.&#39;</span> <span class="o">%</span>
                      <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwr&#39;</span><span class="p">],</span> <span class="n">SimulationWarning</span><span class="p">)</span>

    <span class="c1"># Make sure no files will be overwritten unless overwrite is enabled</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
        <span class="n">ERROR_MESSAGE</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> exists. Use -O to overwrite.&#39;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outputfile</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="n">ERROR_MESSAGE</span> <span class="o">%</span> <span class="n">outputfile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mdinfo</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="n">ERROR_MESSAGE</span> <span class="o">%</span> <span class="n">mdinfo</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">restart</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;imin&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="n">ERROR_MESSAGE</span> <span class="o">%</span> <span class="n">restart</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">trajectory</span><span class="p">)</span> <span class="ow">and</span> <span class="n">runmd</span> <span class="ow">and</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwx&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="n">ERROR_MESSAGE</span> <span class="o">%</span> <span class="n">trajectory</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mdvel</span><span class="p">)</span> <span class="ow">and</span> <span class="n">runmd</span> <span class="ow">and</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwv&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="n">ERROR_MESSAGE</span> <span class="o">%</span> <span class="n">mdvel</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mdfrc</span><span class="p">)</span> <span class="ow">and</span> <span class="n">runmd</span> <span class="ow">and</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwf&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="n">ERROR_MESSAGE</span> <span class="o">%</span> <span class="n">mdfrc</span><span class="p">)</span>

    <span class="c1"># Set some dependent defaults</span>
    <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntb&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;igb&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntp&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">mdin</span><span class="o">.</span><span class="n">change</span><span class="p">(</span><span class="s1">&#39;cntrl&#39;</span><span class="p">,</span> <span class="s1">&#39;ntb&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mdin</span><span class="o">.</span><span class="n">change</span><span class="p">(</span><span class="s1">&#39;cntrl&#39;</span><span class="p">,</span> <span class="s1">&#39;ntb&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mdin</span><span class="o">.</span><span class="n">change</span><span class="p">(</span><span class="s1">&#39;cntrl&#39;</span><span class="p">,</span> <span class="s1">&#39;ntb&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;cut&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntb&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;cut&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">8.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;cut&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1000.0</span>

    <span class="c1"># Determine our cutoff and electrostatic method</span>
    <span class="n">gbmeth</span><span class="p">,</span> <span class="n">kappa</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">0.0</span>
    <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntb&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Interpret cutoffs greater than 500 Angstroms as infinite</span>
        <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;cut&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">500</span><span class="p">:</span>
            <span class="n">nbmeth</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">NoCutoff</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nbmeth</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">CutoffNonPeriodic</span>
        <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;igb&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">gbmeth</span> <span class="o">=</span> <span class="n">HCT</span>
        <span class="k">elif</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;igb&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">gbmeth</span> <span class="o">=</span> <span class="n">OBC1</span>
        <span class="k">elif</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;igb&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">gbmeth</span> <span class="o">=</span> <span class="n">OBC2</span>
        <span class="k">elif</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;igb&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
            <span class="n">gbmeth</span> <span class="o">=</span> <span class="n">GBn</span>
        <span class="k">elif</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;igb&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">gbmeth</span> <span class="o">=</span> <span class="n">GBn2</span>
        <span class="c1"># Inverse Debye length assuming dielectric of 78.5 and T=298.15K</span>
        <span class="c1"># (multiplied by 0.73 to account for lack of ion-ion exclusions)</span>
        <span class="n">kappa</span> <span class="o">=</span> <span class="mf">0.73</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;saltcon&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.10806</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Periodic</span>
        <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">ewald_nml</span><span class="p">[</span><span class="s1">&#39;ew_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nbmeth</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">PME</span>
        <span class="k">elif</span> <span class="n">mdin</span><span class="o">.</span><span class="n">ewald_nml</span><span class="p">[</span><span class="s1">&#39;ew_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nbmeth</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">Ewald</span>
        <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">ewald_nml</span><span class="p">[</span><span class="s1">&#39;eedmeth&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;cut&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>
                <span class="n">nbmeth</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">NoCutoff</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nbmeth</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">CutoffPeriodic</span>
        <span class="k">elif</span> <span class="n">mdin</span><span class="o">.</span><span class="n">ewald_nml</span><span class="p">[</span><span class="s1">&#39;eedmeth&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;eedmeth must be 1 or 4. Other values are ignored.&#39;</span><span class="p">,</span>
                          <span class="n">SimulationWarning</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">ewald_nml</span><span class="p">[</span><span class="s1">&#39;vdwmeth&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;vdwmeth must be 0 or 1&#39;</span><span class="p">)</span>

    <span class="c1"># Determine our constraints</span>
    <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntc&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">rw</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntc&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">HBonds</span>
        <span class="n">rw</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntc&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">AllBonds</span>
        <span class="n">rw</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;ntc must be 1, 2, or 3&#39;</span><span class="p">)</span>
   
    <span class="c1"># Determine if these constraints are flexible (their energies are computed)</span>
    <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntf&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">flexconst</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntf&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">flexconst</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntf&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntf&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">flexconst</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;ntf &gt; 2 just implies no constraints are flexible.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;ntf must be between 0 and 8&#39;</span><span class="p">)</span>

    <span class="c1"># Create the OpenMM System object from our current options</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">start_timer</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">printprogress</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Setting up the OpenMM system...&#39;</span><span class="p">)</span>
    <span class="n">system</span> <span class="o">=</span> <span class="n">parm</span><span class="o">.</span><span class="n">createSystem</span><span class="p">(</span><span class="n">nonbondedMethod</span><span class="o">=</span><span class="n">nbmeth</span><span class="p">,</span>
                     <span class="n">nonbondedCutoff</span><span class="o">=</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;cut&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="p">,</span>
                     <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">,</span> <span class="n">rigidWater</span><span class="o">=</span><span class="n">rw</span><span class="p">,</span>
                     <span class="n">implicitSolvent</span><span class="o">=</span><span class="n">gbmeth</span><span class="p">,</span>
                     <span class="n">implicitSolventKappa</span><span class="o">=</span><span class="n">kappa</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="p">),</span>
                     <span class="n">soluteDielectric</span><span class="o">=</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;intdiel&#39;</span><span class="p">],</span>
                     <span class="n">solventDielectric</span><span class="o">=</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;extdiel&#39;</span><span class="p">],</span>
                     <span class="n">removeCMMotion</span><span class="o">=</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;nscm&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span>
                     <span class="n">ewaldErrorTolerance</span><span class="o">=</span><span class="n">mdin</span><span class="o">.</span><span class="n">ewald_nml</span><span class="p">[</span><span class="s1">&#39;rsum_tol&#39;</span><span class="p">],</span>
                     <span class="n">flexibleConstraints</span><span class="o">=</span><span class="n">flexconst</span><span class="p">,</span>
                     <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="c1"># Log it if requested</span>
    <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;system = parm.createSystem(nonbondedMethod=</span><span class="si">%s</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;                nonbondedCutoff=</span><span class="si">%s</span><span class="s2">*u.angstrom,</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;                constraints=</span><span class="si">%s</span><span class="s2">, rigidWater=</span><span class="si">%s</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;                implicitSolvent=</span><span class="si">%s</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;                implicitSolventKappa=</span><span class="si">%s</span><span class="s2">*(1.0/u.angstrom),</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;                soluteDielectric=</span><span class="si">%s</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;                solventDielectric=</span><span class="si">%s</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;                removeCMMotion=</span><span class="si">%s</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;                ewaldErrorTolerance=</span><span class="si">%s</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;                flexibleConstraints=</span><span class="si">%s</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;                verbose=False,</span><span class="se">\n</span><span class="s2">)</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">nbmeth</span><span class="p">,</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;cut&#39;</span><span class="p">],</span> <span class="n">constraints</span><span class="p">,</span> <span class="n">rw</span><span class="p">,</span> <span class="n">gbmeth</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span>
                <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;intdiel&#39;</span><span class="p">],</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;extdiel&#39;</span><span class="p">],</span>
                <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;nscm&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">mdin</span><span class="o">.</span><span class="n">ewald_nml</span><span class="p">[</span><span class="s1">&#39;rsum_tol&#39;</span><span class="p">],</span> <span class="n">flexconst</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># See if we need to turn off the long-range dispersion correction</span>
    <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntb&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">mdin</span><span class="o">.</span><span class="n">ewald_nml</span><span class="p">[</span><span class="s1">&#39;vdwmeth&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Disable the long-range vdW correction</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">frc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">getForces</span><span class="p">()):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">frc</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="p">)):</span>
                <span class="n">frc</span><span class="o">.</span><span class="n">setUseDispersionCorrection</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# Disable long-range vdW correction</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;system.getForces()[</span><span class="si">%d</span><span class="s1">].&#39;</span> <span class="o">%</span> <span class="n">i</span> <span class="o">+</span>
                                     <span class="s1">&#39;setUseDispersionCorrection(False)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">frc</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="p">):</span>
                <span class="n">frc</span><span class="o">.</span><span class="n">setUseLongRangeCorrection</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# Disable long-range vdW correction</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;system.getForces()[</span><span class="si">%d</span><span class="s1">].&#39;</span> <span class="o">%</span> <span class="n">i</span> <span class="o">+</span>
                                     <span class="s1">&#39;setUseLongRangeCorrection(False)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">timer</span><span class="o">.</span><span class="n">stop_timer</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">)</span>
   
    <span class="c1"># See if we need to add positional restraints</span>
    <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntr&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">timer</span><span class="o">.</span><span class="n">add_timer</span><span class="p">(</span><span class="s1">&#39;restraints&#39;</span><span class="p">,</span> <span class="s1">&#39;Setting up positional restraints&#39;</span><span class="p">)</span>
        <span class="n">timer</span><span class="o">.</span><span class="n">start_timer</span><span class="p">(</span><span class="s1">&#39;restraints&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">printprogress</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Setting up the restraints...&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;restraint_wt&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;Restraint weight must be &gt; 0 for restrained &#39;</span>
                                  <span class="s1">&#39;dynamics&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;restraintmask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;Restrained atom selection must be made via &#39;</span>
                                  <span class="s1">&#39;restraintmask&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Set up the restrained atom selection mask</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;mask = AmberMask(parm, &#39;</span><span class="si">%s</span><span class="s2">&#39;)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span>
                             <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;restraintmask&#39;</span><span class="p">])</span>
            <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;refc = Rst7.open(&quot;</span><span class="si">%s</span><span class="s1">&quot;)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">refc</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="n">parm</span><span class="p">,</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;restraintmask&#39;</span><span class="p">])</span>
        <span class="n">system</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">positional_restraints</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span>
                        <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;restraint_wt&#39;</span><span class="p">]</span> <span class="o">*</span> 
                        <span class="n">u</span><span class="o">.</span><span class="n">kilocalorie_per_mole</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="p">,</span>
                        <span class="n">Rst7</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">refc</span><span class="p">),</span> <span class="n">scriptfile</span><span class="o">=</span><span class="n">scriptfile</span><span class="p">,)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;system.addForce(frc)</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">timer</span><span class="o">.</span><span class="n">stop_timer</span><span class="p">(</span><span class="s1">&#39;restraints&#39;</span><span class="p">)</span>

    <span class="c1"># See if we need to add a barostat</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntb&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntp&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">runmd</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;constant pressure requires a thermostat&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;barostat&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;Berendsen barostat is not implemented in &#39;</span>
                                  <span class="s1">&#39;OpenMM. Use the MC barostat instead &#39;</span>
                                  <span class="s1">&#39;(barostat=2)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntp&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Isotropic scaling</span>
            <span class="n">barostat</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">MonteCarloBarostat</span><span class="p">(</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;pres0&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span>
                                <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;temp0&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">kelvin</span><span class="p">,</span>
                                <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;mcbarint&#39;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;barostat = MonteCarloBarostat(</span><span class="si">%s</span><span class="s1">*u.bar,</span><span class="se">\n</span><span class="s1">&#39;</span>
                                 <span class="s1">&#39;                    </span><span class="si">%s</span><span class="s1">*u.kelvin, </span><span class="si">%s</span><span class="se">\n</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                                 <span class="p">(</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;pres0&#39;</span><span class="p">],</span>
                                 <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;temp0&#39;</span><span class="p">],</span>
                                 <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;mcbarint&#39;</span><span class="p">])</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntp&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># Anisotropic scaling</span>
            <span class="n">barostat</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">MonteCarloAnisotropicBarostat</span><span class="p">(</span>
                            <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;pres0&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span>
                            <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;temp0&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">kelvin</span><span class="p">,</span>
                            <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;mcbarint&#39;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="s1">&#39;barostat = MonteCarloAnisotropicBarostat(</span><span class="si">%s</span><span class="s1">*u.bar,</span><span class="se">\n</span><span class="s1">  &#39;</span>
                        <span class="s1">&#39;               </span><span class="si">%s</span><span class="s1">*u.kelvin, True, True, True, </span><span class="si">%s</span><span class="se">\n</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;pres0&#39;</span><span class="p">],</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;temp0&#39;</span><span class="p">],</span>
                       <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;mcbarint&#39;</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;ntp must be 1 or 2 for constant pressure&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;system.addForce(barostat)</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">system</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">barostat</span><span class="p">)</span>

    <span class="c1"># Set the integrator (we need this to set constraint parameters even in</span>
    <span class="c1"># minimization if someone requested SHAKEn minimization). Then set the</span>
    <span class="c1"># tolerance and get the simulation platform</span>
    <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">integrator</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">LangevinIntegrator</span><span class="p">(</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;temp0&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">kelvin</span><span class="p">,</span>
                            <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;gamma_ln&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">picosecond</span><span class="p">,</span>
                            <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">picosecond</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="s1">&#39;integrator = LangevinIntegrator(</span><span class="si">%s</span><span class="s1">*u.kelvin, &#39;</span>
                    <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/u.picosecond,</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;                    </span><span class="si">%s</span><span class="s1">*u.picosecond</span><span class="se">\n</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;temp0&#39;</span><span class="p">],</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;gamma_ln&#39;</span><span class="p">],</span>
                     <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">])</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;ntt must be 2 or 3 for OpenMM (Andersen &#39;</span>
                                  <span class="s1">&#39;thermostat or Langevin dynamics&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;system.addForce(AndersenThermostat(</span><span class="si">%s</span><span class="s1">*&#39;</span>
                                 <span class="s1">&#39;u.kelvin, </span><span class="si">%s</span><span class="se">\n</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;temp0&#39;</span><span class="p">],</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;vrand&#39;</span><span class="p">]))</span>
            <span class="n">system</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">AndersenThermostat</span><span class="p">(</span>
                    <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;temp0&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">kelvin</span><span class="p">,</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;vrand&#39;</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;integrator = VerletIntegrator(</span><span class="si">%s</span><span class="s1">*u.picosecond)</span><span class="se">\n</span><span class="s1">&#39;</span>
                             <span class="o">%</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">])</span>
        <span class="n">integrator</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">VerletIntegrator</span><span class="p">(</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">picosecond</span><span class="p">)</span>

    <span class="c1"># Set the constraint tolerance on the integrator</span>
    <span class="k">if</span> <span class="n">constraints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">integrator</span><span class="o">.</span><span class="n">setConstraintTolerance</span><span class="p">(</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;tol&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;integrator.setConstraintTolerance(</span><span class="si">%s</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                                <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;tol&#39;</span><span class="p">])</span>

    <span class="c1"># Define the platform if it was requested, or just take the default</span>
    <span class="k">if</span> <span class="n">plat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">plat</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;CUDA&#39;</span><span class="p">,</span> <span class="s1">&#39;Reference&#39;</span><span class="p">,</span> <span class="s1">&#39;CPU&#39;</span><span class="p">,</span> <span class="s1">&#39;OpenCL&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;Platform must be one of CUDA, Reference, &#39;</span>
                                <span class="s1">&#39;CPU, or OpenCL&#39;</span><span class="p">)</span>
        <span class="n">platform</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">Platform</span><span class="o">.</span><span class="n">getPlatformByName</span><span class="p">(</span><span class="n">plat</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;platform = Platform.getPlatformByName(&quot;</span><span class="si">%s</span><span class="s1">&quot;)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                             <span class="n">plat</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;platform = None</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">platform</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">prec</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;mixed&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="s1">&#39;single&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;Invalid precision model [</span><span class="si">%s</span><span class="s1">]. Must be single, &#39;</span>
                              <span class="s1">&#39;double, or mixed.&#39;</span> <span class="o">%</span> <span class="n">prec</span><span class="p">)</span>

    <span class="c1"># Create the Simulation object</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">add_timer</span><span class="p">(</span><span class="s1">&#39;simulation&#39;</span><span class="p">,</span> <span class="s1">&#39;Creating the Simulation object&#39;</span><span class="p">)</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">start_timer</span><span class="p">(</span><span class="s1">&#39;simulation&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">printprogress</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Setting up the simulation...&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;simulation = Simulation(parm.topology, system, &#39;</span>
                         <span class="s1">&#39;integrator, platform)</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">simulation</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span><span class="n">parm</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span> <span class="n">platform</span><span class="p">)</span>

    <span class="c1"># Now set the default precision model. This needs to be done based on the</span>
    <span class="c1"># chosen platform. To handle the case where we chose the default platform,</span>
    <span class="c1"># we need to get the platform from the current context</span>
    <span class="k">if</span> <span class="n">platform</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">platform</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getPlatform</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;platform = simulation.context.getPlatform()</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;CUDA&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;platform.setPropertyValue(simulation.context, &#39;</span>
                             <span class="s2">&quot;&#39;CudaPrecision&#39;, &#39;</span><span class="si">%s</span><span class="s2">&#39;)</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">prec</span><span class="p">)</span>
        <span class="n">platform</span><span class="o">.</span><span class="n">setPropertyValue</span><span class="p">(</span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="s1">&#39;CudaPrecision&#39;</span><span class="p">,</span> <span class="n">prec</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">platform</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;OpenCL&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;platform.setPropertyValue(simulation.context, &#39;</span>
                             <span class="s2">&quot;&#39;OpenCLPrecision&#39;, &#39;</span><span class="si">%s</span><span class="s2">&#39;)</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">prec</span><span class="p">)</span>
        <span class="n">platform</span><span class="o">.</span><span class="n">setPropertyValue</span><span class="p">(</span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="s1">&#39;OpenCLPrecision&#39;</span><span class="p">,</span> <span class="n">prec</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">platform</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Reference&#39;</span> <span class="ow">and</span> <span class="n">prec</span> <span class="o">!=</span> <span class="s1">&#39;double&#39;</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;The Reference platform only uses double precision&#39;</span><span class="p">,</span>
                      <span class="n">SimulationWarning</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">platform</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;CPU&#39;</span> <span class="ow">and</span> <span class="n">prec</span> <span class="o">!=</span> <span class="s1">&#39;single&#39;</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;The CPU platform only uses single precision&#39;</span><span class="p">,</span>
                      <span class="n">SimulationWarning</span><span class="p">)</span>

    <span class="c1"># Set the particle positions and box vectors (if applicable) from either the</span>
    <span class="c1"># given restart file or from the topology file object. Also use particle</span>
    <span class="c1"># velocities if requested via irest=1</span>
    <span class="k">if</span> <span class="n">printprogress</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Setting up initial coordinates and velocities...&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">inpcrd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">position_container</span> <span class="o">=</span> <span class="n">Rst7</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">inpcrd</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">position_container</span><span class="o">.</span><span class="n">natom</span> <span class="o">!=</span> <span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;natom&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;inpcrd [</span><span class="si">%s</span><span class="s1">] and prmtop mismatch in number &#39;</span>
                                  <span class="s1">&#39;of atoms&#39;</span> <span class="o">%</span> <span class="n">inpcrd</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">position_container</span> <span class="o">=</span> <span class="n">parm</span>
    <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# Set the positions and box vectors</span><span class="se">\n</span><span class="s1">&#39;</span>
                         <span class="s1">&#39;simulation.context.setPositions(parm.positions)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPositions</span><span class="p">(</span><span class="n">position_container</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;ifbox&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Only set box vectors if box is present</span>
        <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;simulation.context.&#39;</span>
                             <span class="s1">&#39;setPeriodicBoxVectors(*parm.box_vectors)</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPeriodicBoxVectors</span><span class="p">(</span>
                    <span class="o">*</span><span class="n">position_container</span><span class="o">.</span><span class="n">box_vectors</span><span class="p">)</span>

    <span class="c1"># Velocities</span>
    <span class="k">if</span> <span class="n">runmd</span> <span class="ow">and</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;irest&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">position_container</span><span class="o">.</span><span class="n">hasvels</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# Set velocities</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;simulation.context.setVelocities&#39;</span>
                             <span class="s1">&#39;(parm.velocities)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setVelocities</span><span class="p">(</span><span class="n">position_container</span><span class="o">.</span><span class="n">velocities</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">runmd</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# Set velocities</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;simulation.context.setVelocitiesToTemperature(</span><span class="se">\n</span><span class="s1">&#39;</span>
                          <span class="s1">&#39;           </span><span class="si">%s</span><span class="s1">*u.kelvin)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;tempi&#39;</span><span class="p">])</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setVelocitiesToTemperature</span><span class="p">(</span>
                                        <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;tempi&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">kelvin</span><span class="p">)</span>
    <span class="c1"># Add the energy reporter</span>
    <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# Add the state data reporters</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;rep = StateDataReporter(&quot;</span><span class="si">%s</span><span class="s1">&quot;, </span><span class="si">%s</span><span class="s1">, volume=</span><span class="si">%s</span><span class="s1">,&#39;</span>
                <span class="s1">&#39;density=</span><span class="si">%s</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">outputfile</span><span class="p">,</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntpr&#39;</span><span class="p">],</span>
                <span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;ifbox&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">runmd</span> <span class="ow">and</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntp&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;simulation.reporters.append(rep)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;rep = ProgressReporter(&quot;</span><span class="si">%s</span><span class="s1">&quot;, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, volume=</span><span class="si">%s</span><span class="s1">, &#39;</span>
                <span class="s1">&#39;density=</span><span class="si">%s</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mdinfo</span><span class="p">,</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntpr&#39;</span><span class="p">],</span>
                <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;nstlim&#39;</span><span class="p">],</span> <span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;ifbox&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">runmd</span> <span class="ow">and</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntp&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;simulation.reporters.append(rep)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">rep</span> <span class="o">=</span> <span class="n">StateDataReporter</span><span class="p">(</span><span class="n">outputfile</span><span class="p">,</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntpr&#39;</span><span class="p">],</span>
                    <span class="n">volume</span><span class="o">=</span><span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;ifbox&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="n">density</span><span class="o">=</span><span class="n">runmd</span> <span class="ow">and</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntp&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rep</span><span class="p">)</span>
    <span class="n">rep</span> <span class="o">=</span> <span class="n">ProgressReporter</span><span class="p">(</span><span class="n">mdinfo</span><span class="p">,</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntpr&#39;</span><span class="p">],</span>
                <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;nstlim&#39;</span><span class="p">],</span> <span class="n">volume</span><span class="o">=</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntb&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">density</span><span class="o">=</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntb&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rep</span><span class="p">)</span>
      
    <span class="n">timer</span><span class="o">.</span><span class="n">stop_timer</span><span class="p">(</span><span class="s1">&#39;simulation&#39;</span><span class="p">)</span>

    <span class="c1"># Now see if we wanted minimization or not</span>
    <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;imin&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># We&#39;re doing minimization</span>
        <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;imin&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">timer</span><span class="o">.</span><span class="n">add_timer</span><span class="p">(</span><span class="s1">&#39;minimization&#39;</span><span class="p">,</span> <span class="s1">&#39;Structure minimization&#39;</span><span class="p">)</span>
            <span class="n">timer</span><span class="o">.</span><span class="n">start_timer</span><span class="p">(</span><span class="s1">&#39;minimization&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">printprogress</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Minimizing...&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;rep = EnergyMinimizerReporter(&quot;</span><span class="si">%s</span><span class="s1">&quot;, &#39;</span>
                                 <span class="s1">&#39;volume=</span><span class="si">%s</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                                 <span class="p">(</span><span class="n">outputfile</span><span class="p">,</span> <span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;ifbox&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;rep.report(simulation)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# Minimize the energy</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;simulation.minimizeEnergy(</span><span class="se">\n</span><span class="s1">&#39;</span>
                                <span class="s1">&#39;      tolerance=</span><span class="si">%s</span><span class="s1">*u.kilocalories_per_mole,</span><span class="se">\n</span><span class="s1">&#39;</span>
                                <span class="s1">&#39;      maxIterations=</span><span class="si">%s</span><span class="se">\n</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;drms&#39;</span><span class="p">],</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;maxcyc&#39;</span><span class="p">])</span>
                <span class="p">)</span>
                <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;rep.report(simulation)</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# Write the restart file</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="s1">&#39;restrt_reporter = RestartReporter(&quot;</span><span class="si">%s</span><span class="s1">&quot;, 1,</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;                       False, </span><span class="si">%s</span><span class="s1">, write_velocities=False</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">restart</span><span class="p">,</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntxo&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;restrt_reporter.report(simulation,</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;      simulation.context.getState(getPositions=True,</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;         enforcePeriodicBox=</span><span class="si">%s</span><span class="s1">)</span><span class="se">\n</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                    <span class="nb">bool</span><span class="p">(</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntb&#39;</span><span class="p">]))</span>
            <span class="n">rep</span> <span class="o">=</span> <span class="n">EnergyMinimizerReporter</span><span class="p">(</span><span class="n">outputfile</span><span class="p">,</span>
                                          <span class="n">volume</span><span class="o">=</span><span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;ifbox&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">rep</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">simulation</span><span class="p">)</span>
            <span class="n">simulation</span><span class="o">.</span><span class="n">minimizeEnergy</span><span class="p">(</span>
                    <span class="n">tolerance</span><span class="o">=</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;drms&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">kilocalories_per_mole</span><span class="p">,</span>
                    <span class="n">maxIterations</span><span class="o">=</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;maxcyc&#39;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">rep</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">simulation</span><span class="p">)</span>
            <span class="c1"># Write a restart file with the new coordinates</span>
            <span class="n">restrt_reporter</span> <span class="o">=</span> <span class="n">RestartReporter</span><span class="p">(</span><span class="n">restart</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;natom&#39;</span><span class="p">),</span>
                    <span class="kc">False</span><span class="p">,</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntxo&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="n">write_velocities</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">restrt_reporter</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">simulation</span><span class="p">,</span>
                <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getPositions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">enforcePeriodicBox</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntb&#39;</span><span class="p">]))</span>
            <span class="p">)</span>
            <span class="n">timer</span><span class="o">.</span><span class="n">stop_timer</span><span class="p">(</span><span class="s1">&#39;minimization&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;imin&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">timer</span><span class="o">.</span><span class="n">add_timer</span><span class="p">(</span><span class="s1">&#39;minimization&#39;</span><span class="p">,</span> <span class="s1">&#39;Structure minimization&#39;</span><span class="p">)</span>
            <span class="n">timer</span><span class="o">.</span><span class="n">start_timer</span><span class="p">(</span><span class="s1">&#39;minimization&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">printprogress</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Minimizing...&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">inptraj</span> <span class="o">=</span> <span class="n">NetCDFTraj</span><span class="o">.</span><span class="n">open_old</span><span class="p">(</span><span class="n">inptrajname</span><span class="p">)</span>
                <span class="n">nframes</span> <span class="o">=</span> <span class="n">inptraj</span><span class="o">.</span><span class="n">frame</span>
                <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;inptraj = NetCDFTraj.open_old(&quot;</span><span class="si">%s</span><span class="s1">&quot;)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                                     <span class="n">inptrajname</span><span class="p">)</span>
                    <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;nframes = inptraj.frame</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                <span class="n">inptraj</span> <span class="o">=</span> <span class="n">AmberMdcrd</span><span class="p">(</span><span class="n">inptrajname</span><span class="p">,</span> <span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;natom&#39;</span><span class="p">),</span>
                                     <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntb&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="n">nframes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inptraj</span><span class="o">.</span><span class="n">coordinates</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;inptraj = AmberMdcrd(&quot;</span><span class="si">%s</span><span class="s1">&quot;, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, &#39;</span>
                                     <span class="s1">&#39;mode=&quot;r&quot;)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">inptrajname</span><span class="p">,</span> 
                                     <span class="s2">&quot;parm.ptr(&#39;natom&#39;)&quot;</span><span class="p">,</span>
                                     <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntb&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">))</span>
                    <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;nframes = inptraj.frame</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># Create a reporter to handle the minimized coordinates</span>
            <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ioutfm&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">crd_reporter</span> <span class="o">=</span> <span class="n">MdcrdReporter</span><span class="p">(</span><span class="n">trajectory</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;crd_reporter = MdcrdReporter(&quot;</span><span class="si">%s</span><span class="s1">&quot;, 1)</span><span class="se">\n</span><span class="s1">&#39;</span>
                                     <span class="o">%</span> <span class="n">trajectory</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">dcd</span><span class="p">:</span>
                <span class="n">crd_reporter</span> <span class="o">=</span> <span class="n">DCDReporter</span><span class="p">(</span><span class="n">trajectory</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;crd_reporter = DCDReporter(&quot;</span><span class="si">%s</span><span class="s1">&quot;, 1)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                                     <span class="n">trajectory</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">crd_reporter</span> <span class="o">=</span> <span class="n">NetCDFReporter</span><span class="p">(</span><span class="n">trajectory</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;crd_reporter = NetCDFReporter(&quot;</span><span class="si">%s</span><span class="s1">&quot;, 1)</span><span class="se">\n</span><span class="s1">&#39;</span>
                                     <span class="o">%</span> <span class="n">trajectory</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;f = open(&quot;</span><span class="si">%s</span><span class="s1">&quot;, &quot;w&quot;, 0)</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;rep = EnergyMinimizerReporter(f, volume=</span><span class="si">%s</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;for frame in range(nframes)</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;    crds = inptraj.coordinates(frame)</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;    simulation.context.setPositions(</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;         tuple([Vec3(crds[3*i], crds[3*i+1], &#39;</span>
                        <span class="s1">&#39;crds[3*i+2])</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;           for i in range(parm.ptr(&quot;natom&quot;))]) * &#39;</span>
                        <span class="s1">&#39;u.angstroms</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;    )</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">outputfile</span>
                <span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outputfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">rep</span> <span class="o">=</span> <span class="n">EnergyMinimizerReporter</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;ifbox&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nframes</span><span class="p">):</span>
                <span class="n">crds</span> <span class="o">=</span> <span class="n">inptraj</span><span class="o">.</span><span class="n">coordinates</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
                <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPositions</span><span class="p">(</span>
                        <span class="nb">tuple</span><span class="p">([</span><span class="n">Vec3</span><span class="p">(</span><span class="n">crds</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">],</span> <span class="n">crds</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">crds</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;natom&#39;</span><span class="p">))])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">angstroms</span>
                <span class="p">)</span>
                <span class="n">rep</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">simulation</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">frame</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;maxcyc&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;    simulation.minimizeEnergy(</span><span class="se">\n</span><span class="s1">&#39;</span>
                            <span class="s1">&#39;          tolerance=</span><span class="si">%s</span><span class="s1">*u.kilocalories_per_mole,</span><span class="se">\n</span><span class="s1">&#39;</span>
                            <span class="s1">&#39;          maxIterations=</span><span class="si">%s</span><span class="s1">,</span><span class="se">\n</span><span class="s1">&#39;</span>
                            <span class="s1">&#39;    )</span><span class="se">\n</span><span class="s1">&#39;</span>
                            <span class="s1">&#39;    crd_reporter.report(simulation,</span><span class="se">\n</span><span class="s1">&#39;</span>
                            <span class="s1">&#39;        simulation.context.getState(&#39;</span>
                            <span class="s1">&#39;getPositions=True),</span><span class="se">\n</span><span class="s1">    )</span><span class="se">\n</span><span class="s1">&#39;</span>
                            <span class="s1">&#39;    rep.report(simulation)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;drms&#39;</span><span class="p">],</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;maxcyc&#39;</span><span class="p">])</span>
                        <span class="p">)</span>
                    <span class="n">simulation</span><span class="o">.</span><span class="n">minimizeEnergy</span><span class="p">(</span>
                            <span class="n">tolerance</span><span class="o">=</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;drms&#39;</span><span class="p">]</span><span class="o">*</span>
                                      <span class="n">u</span><span class="o">.</span><span class="n">kilocalories_per_mole</span><span class="p">,</span>
                            <span class="n">maxIterations</span><span class="o">=</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;maxcyc&#39;</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">crd_reporter</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">simulation</span><span class="p">,</span>
                            <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getPositions</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="n">rep</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">simulation</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">80</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;    f.write(&quot;=&quot; * 80 + &quot;</span><span class="se">\\</span><span class="s1">n&quot;)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;f.close()</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">timer</span><span class="o">.</span><span class="n">stop_timer</span><span class="p">(</span><span class="s1">&#39;minimization&#39;</span><span class="p">)</span>
    <span class="c1"># Otherwise we want to do dynamics</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">timer</span><span class="o">.</span><span class="n">add_timer</span><span class="p">(</span><span class="s1">&#39;md&#39;</span><span class="p">,</span> <span class="s1">&#39;Molecular Dynamics&#39;</span><span class="p">)</span>
        <span class="n">timer</span><span class="o">.</span><span class="n">start_timer</span><span class="p">(</span><span class="s1">&#39;md&#39;</span><span class="p">)</span>
        <span class="c1"># Coordinate trajectory reporters</span>
        <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwx&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ioutfm&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">MdcrdReporter</span><span class="p">(</span><span class="n">trajectory</span><span class="p">,</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwx&#39;</span><span class="p">])</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;simulation.reporters.append(</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;      MdcrdReporter(&quot;</span><span class="si">%s</span><span class="s1">&quot;, </span><span class="si">%s</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">trajectory</span><span class="p">,</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwx&#39;</span><span class="p">])</span>
                    <span class="p">)</span>
            <span class="k">elif</span> <span class="n">dcd</span><span class="p">:</span>
                <span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">DCDReporter</span><span class="p">(</span><span class="n">trajectory</span><span class="p">,</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwx&#39;</span><span class="p">])</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;simulation.reporters.append(</span><span class="se">\n</span><span class="s1">&#39;</span>
                            <span class="s1">&#39;      DCDReporter(&quot;</span><span class="si">%s</span><span class="s1">&quot;, </span><span class="si">%s</span><span class="s1">)</span><span class="se">\n</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">trajectory</span><span class="p">,</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwx&#39;</span><span class="p">])</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">NetCDFReporter</span><span class="p">(</span><span class="n">trajectory</span><span class="p">,</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwx&#39;</span><span class="p">],</span>
                                <span class="n">crds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vels</span><span class="o">=</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwv&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span>
                                <span class="n">frcs</span><span class="o">=</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwf&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span>
                        <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;simulation.reporters.append(</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;      NetCDFReporter(&quot;</span><span class="si">%s</span><span class="s1">&quot;, </span><span class="si">%s</span><span class="s1">,</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;          crds=True, vels=</span><span class="si">%s</span><span class="s1">, frcs=</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;      )</span><span class="se">\n</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">trajectory</span><span class="p">,</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwx&#39;</span><span class="p">],</span>
                        <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwv&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwf&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="p">)</span>
        <span class="c1"># Velocity trajectory reporters</span>
        <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwv&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ioutfm&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">MdcrdReporter</span><span class="p">(</span><span class="n">mdvel</span><span class="p">,</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwv&#39;</span><span class="p">],</span>
                                <span class="n">crds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">frcs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;simulation.reporters.append(</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;      MdcrdReporter(&quot;</span><span class="si">%s</span><span class="s1">&quot;, </span><span class="si">%s</span><span class="s1">, crds=False,</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;         vels=True, frcs=False)</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">trajectory</span><span class="p">,</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwv&#39;</span><span class="p">])</span>
                    <span class="p">)</span>
            <span class="k">elif</span> <span class="n">dcd</span><span class="p">:</span>
                <span class="c1"># Should never make it here due to earlier checks; catch anyway</span>
                <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;Cannot write velocities to DCD files.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Add forces too only if ntwf &lt; 0 AND no coordinate traj is</span>
                <span class="c1"># being printed (otherwise forces will be printed to the</span>
                <span class="c1"># coordinate file</span>
                <span class="n">_frcs</span> <span class="o">=</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwf&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwx&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span>
                <span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">NetCDFReporter</span><span class="p">(</span><span class="n">mdvel</span><span class="p">,</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwv&#39;</span><span class="p">],</span>
                                <span class="n">crds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">frcs</span><span class="o">=</span><span class="n">_frcs</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;simulation.reporters.append(</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;      NetCDFReporter(&quot;</span><span class="si">%s</span><span class="s1">&quot;, </span><span class="si">%s</span><span class="s1">,</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;          crds=False, vels=True, frcs=</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;      )</span><span class="se">\n</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">mdvel</span><span class="p">,</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwv&#39;</span><span class="p">],</span>
                         <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwf&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwx&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
                    <span class="p">)</span>
        <span class="c1"># Force trajectory reporters</span>
        <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwf&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ioutfm&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">MdcrdReporter</span><span class="p">(</span><span class="n">mdfrc</span><span class="p">,</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwf&#39;</span><span class="p">],</span>
                                      <span class="n">crds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">frcs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;simulation.reporters.append(</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;      MdcrdReporter(&quot;</span><span class="si">%s</span><span class="s1">&quot;, </span><span class="si">%s</span><span class="s1">, crds=False,</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;         vels=False, frcs=True)</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">trajectory</span><span class="p">,</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwf&#39;</span><span class="p">])</span>
                    <span class="p">)</span>
            <span class="k">elif</span> <span class="n">dcd</span><span class="p">:</span>
                <span class="c1"># Should never make it here due to earlier checks; catch anyway</span>
                <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;Cannot write forces to DCD files.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">NetCDFReporter</span><span class="p">(</span><span class="n">mdfrc</span><span class="p">,</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwf&#39;</span><span class="p">],</span>
                                <span class="n">crds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">frcs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;simulation.reporters.append(</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;      NetCDFReporter(&quot;</span><span class="si">%s</span><span class="s1">&quot;, </span><span class="si">%s</span><span class="s1">,</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;          crds=False, vels=False, frcs=True</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;      )</span><span class="se">\n</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mdfrc</span><span class="p">,</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwv&#39;</span><span class="p">])</span>
                    <span class="p">)</span>
        <span class="c1"># Restart file reporter</span>
        <span class="n">restrt_reporter</span> <span class="o">=</span> <span class="n">RestartReporter</span><span class="p">(</span><span class="n">restart</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwr&#39;</span><span class="p">]),</span>
                    <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwr&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntxo&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;restrt_reporter = RestartReporter(&quot;</span><span class="si">%s</span><span class="s1">&quot;, </span><span class="si">%s</span><span class="s1">,</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;      </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">restart</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwr&#39;</span><span class="p">]),</span>
                     <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwr&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntxo&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntwr&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">restrt_reporter</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;simulation.reporters.&#39;</span>
                                 <span class="s1">&#39;append(restrt_reporter)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">printprogress</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Running MD...&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;simulation.step(</span><span class="si">%s</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;final_state = simulation.context.getState(getPositions=True,</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;     getVelocities=True, enforcePeriodicBox=</span><span class="si">%s</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;restrt_reporter.report(simulation, final_state)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;nstlim&#39;</span><span class="p">],</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntb&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">runsim</span><span class="p">:</span>
            <span class="n">simulation</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;nstlim&#39;</span><span class="p">])</span>
            <span class="c1"># Now write the final restart file, hijacking the restart file</span>
            <span class="c1"># reporter</span>
            <span class="n">final_state</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getPositions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">getVelocities</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">enforcePeriodicBox</span><span class="o">=</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;ntb&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span>
            <span class="p">)</span>
            <span class="n">restrt_reporter</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">simulation</span><span class="p">,</span> <span class="n">final_state</span><span class="p">)</span>
            <span class="n">timer</span><span class="o">.</span><span class="n">stop_timer</span><span class="p">(</span><span class="s1">&#39;md&#39;</span><span class="p">)</span>
            <span class="n">nsperday</span> <span class="o">=</span> <span class="p">(</span><span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;nstlim&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span> <span class="o">/</span>
                        <span class="mf">1000.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">timer</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="s1">&#39;md&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">3600</span> <span class="o">/</span> <span class="mi">24</span><span class="p">))</span>

    <span class="n">timer</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">timer</span><span class="o">.</span><span class="n">timer_names</span><span class="p">:</span>
        <span class="n">timer</span><span class="o">.</span><span class="n">print_</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
   
    <span class="k">if</span> <span class="n">mdin</span><span class="o">.</span><span class="n">cntrl_nml</span><span class="p">[</span><span class="s1">&#39;imin&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">runsim</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MD timing: </span><span class="si">%.3f</span><span class="s1"> ns/day&#39;</span> <span class="o">%</span> <span class="n">nsperday</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">scriptfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">scriptfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="energy"><a class="viewcode-back" href="../../../../api/parmed/parmed.tools.simulations.openmm.html#parmed.tools.simulations.openmm.energy">[docs]</a><span class="k">def</span> <span class="nf">energy</span><span class="p">(</span><span class="n">parm</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes a single-point energy using OpenMM and prints the result to the</span>
<span class="sd">    desired output destination (defaults to stdout)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">tempfile</span>
    <span class="k">global</span> <span class="n">HAS_OPENMM</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">HAS_OPENMM</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;Could not import OpenMM!&#39;</span><span class="p">)</span>

    <span class="n">cutoff</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get_key_float</span><span class="p">(</span><span class="s1">&#39;cutoff&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">igb</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get_key_int</span><span class="p">(</span><span class="s1">&#39;igb&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">saltcon</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get_key_float</span><span class="p">(</span><span class="s1">&#39;saltcon&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">do_ewald</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;Ewald&#39;</span><span class="p">)</span>
    <span class="n">plat</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;platform&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">prec</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="s1">&#39;mixed&#39;</span><span class="p">)</span>
    <span class="n">decomp</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;decompose&#39;</span><span class="p">)</span>
    <span class="n">applayer</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;applayer&#39;</span><span class="p">)</span>
    <span class="n">vdw_longrange</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;nodisper&#39;</span><span class="p">)</span>
    <span class="c1"># Get any unmarked arguments</span>
    <span class="n">unmarked_cmds</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">unmarked</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unmarked_cmds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Un-handled arguments: &quot;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unmarked_cmds</span><span class="p">),</span>
                      <span class="n">UnhandledArgumentWarning</span><span class="p">)</span>
   
    <span class="n">gbmeth</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;ifbox&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cutoff</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cutoff</span> <span class="o">&gt;=</span> <span class="mi">500</span><span class="p">:</span>
            <span class="n">nbmeth</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">NoCutoff</span>
            <span class="n">cutoff</span> <span class="o">=</span> <span class="mf">1000.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nbmeth</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">CutoffNonPeriodic</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">igb</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;Bad igb value. Must be 0, 1, 2, 5, &#39;</span>
                                  <span class="s1">&#39;6, 7, or 8&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">igb</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">gbmeth</span> <span class="o">=</span> <span class="n">HCT</span>
        <span class="k">elif</span> <span class="n">igb</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">gbmeth</span> <span class="o">=</span> <span class="n">OBC1</span>
        <span class="k">elif</span> <span class="n">igb</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">gbmeth</span> <span class="o">=</span> <span class="n">OBC2</span>
        <span class="k">elif</span> <span class="n">igb</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
            <span class="n">gbmeth</span> <span class="o">=</span> <span class="n">GBn</span>
        <span class="k">elif</span> <span class="n">igb</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">gbmeth</span> <span class="o">=</span> <span class="n">GBn2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cutoff</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">cutoff</span> <span class="o">=</span> <span class="mf">8.0</span>
        <span class="k">if</span> <span class="n">do_ewald</span><span class="p">:</span>
            <span class="n">nbmeth</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">Ewald</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nbmeth</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">PME</span>

    <span class="n">parm_</span> <span class="o">=</span> <span class="n">parm</span>
    <span class="k">if</span> <span class="n">applayer</span><span class="p">:</span>
        <span class="c1"># Write out a temporary topology file, load an amberprmtopfile, then</span>
        <span class="c1"># delete that file</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mktemp</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.parm7&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">parm</span><span class="o">.</span><span class="n">write_parm</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">parm_</span> <span class="o">=</span> <span class="n">amberprmtopfile</span><span class="o">.</span><span class="n">AmberPrmtopFile</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;Could not create temporary file for app &#39;</span> <span class="c1"># pragma: no cover</span>
                                  <span class="s1">&#39;layer energy calculation.&#39;</span><span class="p">)</span>
<span class="c1">#       except Exception as exc: TODO delete</span>
<span class="c1">#TODO deleteraise SimulationError(&#39;Error creating parm object from app layer. &#39;</span>
<span class="c1">#TODO delete                      &#39;[ %s: %s ]&#39; % (type(exc).__name__, exc))</span>

    <span class="c1"># Time to create the OpenMM system</span>
    <span class="n">system</span> <span class="o">=</span> <span class="n">parm_</span><span class="o">.</span><span class="n">createSystem</span><span class="p">(</span><span class="n">nonbondedMethod</span><span class="o">=</span><span class="n">nbmeth</span><span class="p">,</span>
                                <span class="n">nonbondedCutoff</span><span class="o">=</span><span class="n">cutoff</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="p">,</span>
                                <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rigidWater</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">removeCMMotion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">implicitSolvent</span><span class="o">=</span><span class="n">gbmeth</span><span class="p">,</span>
                                <span class="n">implicitSolventSaltConc</span><span class="o">=</span><span class="n">saltcon</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">molar</span><span class="p">,</span>
                                <span class="n">soluteDielectric</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">solventDielectric</span><span class="o">=</span><span class="mf">78.5</span><span class="p">,</span>
                                <span class="n">ewaldErrorTolerance</span><span class="o">=</span><span class="mi">5</span><span class="n">e</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># If we used the app layer, we need to assign force groups to enable energy</span>
    <span class="c1"># decomposition</span>
    <span class="k">if</span> <span class="n">applayer</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">force</span> <span class="ow">in</span> <span class="n">system</span><span class="o">.</span><span class="n">getForces</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">HarmonicBondForce</span><span class="p">):</span>
                <span class="n">force</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="n">parm</span><span class="o">.</span><span class="n">BOND_FORCE_GROUP</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">HarmonicAngleForce</span><span class="p">):</span>
                <span class="n">force</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="n">parm</span><span class="o">.</span><span class="n">ANGLE_FORCE_GROUP</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">PeriodicTorsionForce</span><span class="p">):</span>
                <span class="n">force</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="n">parm</span><span class="o">.</span><span class="n">DIHEDRAL_FORCE_GROUP</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Treat the rest as nonbonded forces</span>
                <span class="n">force</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="n">parm</span><span class="o">.</span><span class="n">NONBONDED_FORCE_GROUP</span><span class="p">)</span>
        <span class="c1"># For periodic simulations, we need to set the box info</span>
        <span class="k">if</span> <span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;ifbox&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">system</span><span class="o">.</span><span class="n">setDefaultPeriodicBoxVectors</span><span class="p">(</span><span class="o">*</span><span class="n">parm</span><span class="o">.</span><span class="n">box_vectors</span><span class="p">)</span>

    <span class="c1"># Now see if we want to turn on or off the dispersion correction</span>
    <span class="k">for</span> <span class="n">force</span> <span class="ow">in</span> <span class="n">system</span><span class="o">.</span><span class="n">getForces</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="p">):</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setUseDispersionCorrection</span><span class="p">(</span><span class="n">vdw_longrange</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="p">):</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setUseLongRangeCorrection</span><span class="p">(</span><span class="n">vdw_longrange</span><span class="p">)</span>

    <span class="c1"># Create a dummy integrator</span>
    <span class="n">integrator</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">VerletIntegrator</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>

    <span class="c1"># Define the platform if it was requested, or just take the default</span>
    <span class="k">if</span> <span class="n">plat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">plat</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;CUDA&#39;</span><span class="p">,</span> <span class="s1">&#39;Reference&#39;</span><span class="p">,</span> <span class="s1">&#39;CPU&#39;</span><span class="p">,</span> <span class="s1">&#39;OpenCL&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;Platform must be one of CUDA, Reference, &#39;</span>
                                  <span class="s1">&#39;CPU, or OpenCL&#39;</span><span class="p">)</span>
        <span class="n">platform</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">Platform</span><span class="o">.</span><span class="n">getPlatformByName</span><span class="p">(</span><span class="n">plat</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">platform</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">prec</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;mixed&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="s1">&#39;single&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;Invalid precision model [</span><span class="si">%s</span><span class="s1">]. Must be single, &#39;</span>
                              <span class="s1">&#39;double, or mixed.&#39;</span> <span class="o">%</span> <span class="n">prec</span><span class="p">)</span>

    <span class="c1"># Create the Simulation object</span>
    <span class="k">if</span> <span class="n">platform</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">integrator</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span> <span class="n">platform</span><span class="p">)</span>

    <span class="c1"># Set the particle positions</span>
    <span class="n">context</span><span class="o">.</span><span class="n">setPositions</span><span class="p">(</span><span class="n">parm</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>

    <span class="c1"># Now set the default precision model. This needs to be done based on the</span>
    <span class="c1"># chosen platform. To handle the case where we chose the default platform,</span>
    <span class="c1"># we need to get the platform from the current context</span>
    <span class="k">if</span> <span class="n">platform</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">platform</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">getPlatform</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;CUDA&#39;</span><span class="p">:</span>
        <span class="n">platform</span><span class="o">.</span><span class="n">setPropertyValue</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s1">&#39;CudaPrecision&#39;</span><span class="p">,</span> <span class="n">prec</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">platform</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;OpenCL&#39;</span><span class="p">:</span>
        <span class="n">platform</span><span class="o">.</span><span class="n">setPropertyValue</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s1">&#39;OpenCLPrecision&#39;</span><span class="p">,</span> <span class="n">prec</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">platform</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Reference&#39;</span> <span class="ow">and</span> <span class="n">prec</span> <span class="o">!=</span> <span class="s1">&#39;double&#39;</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;The Reference platform only uses double precision&#39;</span><span class="p">,</span>
                      <span class="n">SimulationWarning</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">platform</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;CPU&#39;</span> <span class="ow">and</span> <span class="n">prec</span> <span class="o">!=</span> <span class="s1">&#39;single&#39;</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;The CPU platform only uses single precision&#39;</span><span class="p">,</span>
                      <span class="n">SimulationWarning</span><span class="p">)</span>

    <span class="c1"># Now get the energy</span>
    <span class="n">has_pbc</span> <span class="o">=</span> <span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;ifbox&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">nrg</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalories</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">mole</span>
    <span class="k">if</span> <span class="n">decomp</span><span class="p">:</span>
        <span class="c1"># Now we have to loop through every force group and compute them</span>
        <span class="c1"># individually</span>
      
        <span class="c1"># Bonds first</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">enforcePeriodicBox</span><span class="o">=</span><span class="n">has_pbc</span><span class="p">,</span>
                                 <span class="n">groups</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="n">parm</span><span class="o">.</span><span class="n">BOND_FORCE_GROUP</span><span class="p">)</span>
        <span class="n">bond</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">getPotentialEnergy</span><span class="p">()</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">nrg</span><span class="p">)</span>
        <span class="c1"># Now angles</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">enforcePeriodicBox</span><span class="o">=</span><span class="n">has_pbc</span><span class="p">,</span>
                                 <span class="n">groups</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="n">parm</span><span class="o">.</span><span class="n">ANGLE_FORCE_GROUP</span><span class="p">)</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">getPotentialEnergy</span><span class="p">()</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">nrg</span><span class="p">)</span>
        <span class="c1"># Now dihedrals</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">enforcePeriodicBox</span><span class="o">=</span><span class="n">has_pbc</span><span class="p">,</span>
                                 <span class="n">groups</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="n">parm</span><span class="o">.</span><span class="n">DIHEDRAL_FORCE_GROUP</span><span class="p">)</span>
        <span class="n">dihedral</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">getPotentialEnergy</span><span class="p">()</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">nrg</span><span class="p">)</span>
        <span class="c1"># Now the CHARMM-specific terms</span>
        <span class="k">if</span> <span class="n">parm</span><span class="o">.</span><span class="n">chamber</span><span class="p">:</span>
            <span class="c1"># Now Urey-Bradley energy</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">enforcePeriodicBox</span><span class="o">=</span><span class="n">has_pbc</span><span class="p">,</span>
                                     <span class="n">groups</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="n">parm</span><span class="o">.</span><span class="n">UREY_BRADLEY_FORCE_GROUP</span><span class="p">)</span>
            <span class="n">ub</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">getPotentialEnergy</span><span class="p">()</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">nrg</span><span class="p">)</span>
            <span class="c1"># Now improper</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">enforcePeriodicBox</span><span class="o">=</span><span class="n">has_pbc</span><span class="p">,</span>
                                     <span class="n">groups</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="n">parm</span><span class="o">.</span><span class="n">IMPROPER_FORCE_GROUP</span><span class="p">)</span>
            <span class="n">imp</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">getPotentialEnergy</span><span class="p">()</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">nrg</span><span class="p">)</span>
            <span class="c1"># Now cmap</span>
            <span class="k">if</span> <span class="n">parm</span><span class="o">.</span><span class="n">has_cmap</span><span class="p">:</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                         <span class="n">enforcePeriodicBox</span><span class="o">=</span><span class="n">has_pbc</span><span class="p">,</span>
                                         <span class="n">groups</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="n">parm</span><span class="o">.</span><span class="n">CMAP_FORCE_GROUP</span><span class="p">)</span>
                <span class="n">cmap</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">getPotentialEnergy</span><span class="p">()</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">nrg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cmap</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Now non-bonded. No real way to decompose this.</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">enforcePeriodicBox</span><span class="o">=</span><span class="n">has_pbc</span><span class="p">,</span>
                                <span class="n">groups</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="n">parm</span><span class="o">.</span><span class="n">NONBONDED_FORCE_GROUP</span><span class="p">)</span>
        <span class="n">nonbond</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">getPotentialEnergy</span><span class="p">()</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">nrg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">parm</span><span class="o">.</span><span class="n">chamber</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Bond         = </span><span class="si">%20.7f</span><span class="s1">     Angle        = </span><span class="si">%20.7f</span><span class="se">\n</span><span class="s1">&#39;</span>
                         <span class="s1">&#39;Dihedral     = </span><span class="si">%20.7f</span><span class="s1">     Urey-Bradley = </span><span class="si">%20.7f</span><span class="se">\n</span><span class="s1">&#39;</span>
                         <span class="s1">&#39;Improper     = </span><span class="si">%20.7f</span><span class="s1">     &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bond</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">dihedral</span><span class="p">,</span>
                         <span class="n">ub</span><span class="p">,</span> <span class="n">imp</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">parm</span><span class="o">.</span><span class="n">has_cmap</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;CMAP         = </span><span class="si">%20.7f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cmap</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Nonbond      = </span><span class="si">%20.7f</span><span class="se">\n</span><span class="s1">&#39;</span>
                         <span class="s1">&#39;TOTAL        = </span><span class="si">%20.7f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nonbond</span><span class="p">,</span>
                         <span class="n">bond</span><span class="o">+</span><span class="n">angle</span><span class="o">+</span><span class="n">dihedral</span><span class="o">+</span><span class="n">ub</span><span class="o">+</span><span class="n">imp</span><span class="o">+</span><span class="n">cmap</span><span class="o">+</span><span class="n">nonbond</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Bond     = </span><span class="si">%20.7f</span><span class="s1">     Angle    = </span><span class="si">%20.7f</span><span class="se">\n</span><span class="s1">&#39;</span>
                         <span class="s1">&#39;Dihedral = </span><span class="si">%20.7f</span><span class="s1">     Nonbond  = </span><span class="si">%20.7f</span><span class="se">\n</span><span class="s1">&#39;</span>
                         <span class="s1">&#39;TOTAL    = </span><span class="si">%20.7f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bond</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">dihedral</span><span class="p">,</span>
                          <span class="n">nonbond</span><span class="p">,</span> <span class="p">(</span><span class="n">bond</span><span class="o">+</span><span class="n">angle</span><span class="o">+</span><span class="n">dihedral</span><span class="o">+</span><span class="n">nonbond</span><span class="p">)))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="n">enforcePeriodicBox</span><span class="o">=</span><span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;ifbox&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Potential Energy = </span><span class="si">%.7f</span><span class="s1"> kcal/mol</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                     <span class="n">state</span><span class="o">.</span><span class="n">getPotentialEnergy</span><span class="p">()</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">nrg</span><span class="p">))</span></div>

<div class="viewcode-block" id="minimize"><a class="viewcode-back" href="../../../../api/parmed/parmed.tools.simulations.openmm.html#parmed.tools.simulations.openmm.minimize">[docs]</a><span class="k">def</span> <span class="nf">minimize</span><span class="p">(</span><span class="n">parm</span><span class="p">,</span> <span class="n">igb</span><span class="p">,</span> <span class="n">saltcon</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">,</span> <span class="n">restraintmask</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span>
             <span class="n">script</span><span class="p">,</span> <span class="n">platform</span><span class="p">,</span> <span class="n">precision</span><span class="p">,</span> <span class="n">norun</span><span class="p">,</span> <span class="n">tol</span><span class="p">,</span> <span class="n">maxcyc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Minimizes a snapshot. Use the existing System if it exists &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">HAS_OPENMM</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">HAS_OPENMM</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;Could not import OpenMM!&#39;</span><span class="p">)</span>

    <span class="c1"># Open the script file</span>
    <span class="k">if</span> <span class="n">script</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scriptfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_SCRIPT_HEADER</span> <span class="o">%</span> <span class="p">(</span><span class="n">parm</span><span class="p">,</span> <span class="n">parm</span><span class="o">.</span><span class="n">crdname</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scriptfile</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">gbmeth</span><span class="p">,</span> <span class="n">kappa</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">0.0</span>
    <span class="k">if</span> <span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;ifbox&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cutoff</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cutoff</span> <span class="o">&gt;=</span> <span class="mi">500</span><span class="p">:</span>
            <span class="n">nbmeth</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">NoCutoff</span>
            <span class="n">cutoff</span> <span class="o">=</span> <span class="mf">1000.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nbmeth</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">CutoffNonPeriodic</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">igb</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;Bad igb value. Must be 0, 1, 2, 5, &#39;</span>
                                  <span class="s1">&#39;6, 7, or 8&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">igb</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">gbmeth</span> <span class="o">=</span> <span class="n">HCT</span>
        <span class="k">elif</span> <span class="n">igb</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">gbmeth</span> <span class="o">=</span> <span class="n">OBC1</span>
        <span class="k">elif</span> <span class="n">igb</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">gbmeth</span> <span class="o">=</span> <span class="n">OBC2</span>
        <span class="k">elif</span> <span class="n">igb</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
            <span class="n">gbmeth</span> <span class="o">=</span> <span class="n">GBn</span>
        <span class="k">elif</span> <span class="n">igb</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">gbmeth</span> <span class="o">=</span> <span class="n">GBn2</span>
        <span class="c1"># Other choices are vacuum</span>
        <span class="n">kappa</span> <span class="o">=</span> <span class="mf">0.73</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">saltcon</span> <span class="o">*</span> <span class="mf">0.10806</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cutoff</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">cutoff</span> <span class="o">=</span> <span class="mf">8.0</span>
        <span class="n">nbmeth</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">PME</span>

    <span class="c1"># Time to create the OpenMM system</span>
    <span class="n">system</span> <span class="o">=</span> <span class="n">parm</span><span class="o">.</span><span class="n">createSystem</span><span class="p">(</span><span class="n">nonbondedMethod</span><span class="o">=</span><span class="n">nbmeth</span><span class="p">,</span>
                               <span class="n">nonbondedCutoff</span><span class="o">=</span><span class="n">cutoff</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="p">,</span>
                               <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rigidWater</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">removeCMMotion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">implicitSolvent</span><span class="o">=</span><span class="n">gbmeth</span><span class="p">,</span>
                               <span class="n">implicitSolventKappa</span><span class="o">=</span><span class="n">kappa</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="p">),</span>
                               <span class="n">soluteDielectric</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">solventDielectric</span><span class="o">=</span><span class="mf">78.5</span><span class="p">,</span>
                               <span class="n">ewaldErrorTolerance</span><span class="o">=</span><span class="mi">5</span><span class="n">e</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">script</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# Create the system</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;system = parm.createSystem(nonbondedMethod=</span><span class="si">%s</span><span class="s1">,</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;                   nonbondedCutoff=</span><span class="si">%s</span><span class="s1">*u.angstrom,</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;                   constraints=None, rigidWater=True,</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;                   removeCMMotion=False, implicitSolvent=</span><span class="si">%s</span><span class="s1">,</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;                   implicitSolventKappa=</span><span class="si">%s</span><span class="s1">*(1.0/u.angstrom),</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;                   soluteDielectric=1.0,</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;                   solventDielectric=78.5,</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;                   ewaldErrorTolerance=5e-5</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;)</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;# Create a dummy integrator</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;integrator = VerletIntegrator(2.0*u.femtoseconds)</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">nbmeth</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">,</span> <span class="n">gbmeth</span><span class="p">,</span> <span class="n">kappa</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># See if we need to add restraints</span>
    <span class="k">if</span> <span class="n">restraintmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="n">parm</span><span class="p">,</span> <span class="n">restraintmask</span><span class="p">)</span>
        <span class="n">system</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">positional_restraints</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span>
                            <span class="n">u</span><span class="o">.</span><span class="n">kilocalorie_per_mole</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="p">,</span>
                            <span class="n">parm</span><span class="o">.</span><span class="n">rst7</span><span class="p">,</span> <span class="n">scriptfile</span><span class="o">=</span><span class="n">scriptfile</span><span class="p">,)</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">script</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;system.addForce(frc)</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Create a dummy integrator and the simulation</span>
    <span class="n">integrator</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">VerletIntegrator</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">femtoseconds</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">platform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plat</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">Platform</span><span class="o">.</span><span class="n">getPlatformByName</span><span class="p">(</span><span class="n">platform</span><span class="p">)</span>
        <span class="n">simulation</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span><span class="n">parm</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span> <span class="n">plat</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">script</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# Create the platform</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;plat = Platform.getPlatformByName(</span><span class="si">%s</span><span class="s1">)</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;# Create the simulation</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;simulation = Simulation(parm.topology, system, &#39;</span>
                    <span class="s1">&#39;integrator, plat)</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">platform</span><span class="p">)</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">simulation</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span><span class="n">parm</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">integrator</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">script</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# Create the simulation</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;simulation = Simulation(parm.topology, system, &#39;</span>
                    <span class="s1">&#39;integrator)</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Now assign the coordinates</span>
    <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPositions</span><span class="p">(</span><span class="n">parm</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">script</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scriptfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# Setting the positions</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;simulation.context.setPositions(parm.positions)</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;# Minimize the energy</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;simulation.minimizeEnergy(tolerance=</span><span class="si">%s</span><span class="s1">, maxIterations=</span><span class="si">%s</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;# Store the positions back in the parmtop</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;state = simulation.context.getState(getPositions=True</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;                                    enforcePeriodicBox=</span><span class="si">%s</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;parm.positions = state.getPositions()</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;ifbox&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="n">tol</span><span class="p">,</span> <span class="n">maxcyc</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">scriptfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Go ahead and minimize now and set the coordinates from the results of this</span>
    <span class="c1"># minimization if we wanted to run the calculation</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">norun</span><span class="p">:</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">minimizeEnergy</span><span class="p">(</span><span class="n">tolerance</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span> <span class="n">maxIterations</span><span class="o">=</span><span class="n">maxcyc</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Now get the coordinates</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getPositions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">enforcePeriodicBox</span><span class="o">=</span><span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;ifbox&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">parm</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">getPositions</span><span class="p">()</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">ParmEd 2.5.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2015, Jason Swails.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.8.
    </div>
  </body>
</html>